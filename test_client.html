<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopScore AI Test Client</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        #chat-box {
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }

        .message {
            margin-bottom: 10px;
        }

        .user {
            color: blue;
            font-weight: bold;
        }

        .ai {
            color: green;
        }

        .system {
            color: gray;
            font-style: italic;
        }

        .debug {
            color: orange;
            font-size: 0.9em;
        }

        #input-area {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 5px;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: red;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
        }

        .status-connected {
            background-color: green;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>

<body>
    <h1>TopScore AI Test Client <span id="status-indicator" class="status-dot"></span></h1>
    <div id="chat-box"></div>

    <div id="input-area">
        <button onclick="startNewChat()">New Chat</button>
        <select id="model-select">
            <option value="smart">Smart (Deep Agent - Llama 3.3 70B)</option>
            <option value="fast">Fast (Llama 3.1 8B)</option>
            <option value="mixtral">Mixtral 8x7B (GPT-OSS)</option>
            <option value="gemma">Gemma 2 9B</option>
            <option value="llama32_1b">Llama 3.2 1B (Preview)</option>
            <option value="llama32_3b">Llama 3.2 3B (Preview)</option>
            <option value="llama3_70b">Llama 3 70B</option>
            <option value="llama3_8b">Llama 3 8B</option>
        </select>
        <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
        <input type="file" id="image-input" accept="image/*">
        <button onclick="sendMessage()">Send</button>
        <button id="record-btn" onclick="toggleRecording()">üé§ Record</button>
    </div>

    <script>
        const ws = new WebSocket("ws://localhost:8080/ws/chat");
        const chatBox = document.getElementById("chat-box");
        let currentAiResponse = null;
        let currentAiText = "";
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        let currentThreadId = "web_test_thread_" + Date.now();
        const statusIndicator = document.getElementById("status-indicator");

        ws.onopen = () => {
            appendMessage("System", "Connected to server.", "system");
            statusIndicator.classList.add("status-connected");
        };

        ws.onmessage = (event) => {
            // console.log("Received:", event.data); // Debug
            const data = JSON.parse(event.data);

            if (data.type === "token") {
                if (!currentAiResponse) {
                    currentAiResponse = document.createElement("div");
                    currentAiResponse.className = "message ai";
                    chatBox.appendChild(currentAiResponse);
                    currentAiText = "";
                }
                currentAiText += data.content;
                // Render Markdown
                try {
                    const htmlContent = (typeof marked !== 'undefined' && typeof marked.parse === 'function')
                        ? marked.parse(currentAiText)
                        : currentAiText.replace(/\n/g, "<br>");
                    currentAiResponse.innerHTML = "<strong>AI:</strong> " + htmlContent;

                    // Render LaTeX
                    if (typeof renderMathInElement === 'function') {
                        renderMathInElement(currentAiResponse, {
                            delimiters: [
                                { left: '$$', right: '$$', display: true },
                                { left: '$', right: '$', display: false },
                                { left: '\\(', right: '\\)', display: false },
                                { left: '\\[', right: '\\]', display: true }
                            ],
                            throwOnError: false
                        });
                    }
                } catch (e) {
                    console.error("Rendering error:", e);
                    currentAiResponse.innerHTML = "<strong>AI:</strong> " + currentAiText;
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            } else if (data.type === "transcription") {
                appendMessage("You (Voice)", data.content, "user");
            } else if (data.type === "image") {
                const img = document.createElement("img");
                img.src = "data:image/png;base64," + data.content;
                img.style.maxWidth = "100%";
                img.style.marginTop = "10px";

                const div = document.createElement("div");
                div.className = "message ai";
                div.innerHTML = "<strong>AI Generated Image:</strong><br>";
                div.appendChild(img);
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            } else if (data.type === "audio_response") {
                const audio = new Audio(data.content);
                audio.play();
                appendMessage("System", "Playing audio response...", "system");
            } else if (data.type === "info") {
                appendMessage("System", data.content, "system");
            } else if (data.type === "end_turn") {
                if (currentAiResponse) {
                    // Add Play button for TTS
                    const textToRead = currentAiResponse.innerText.replace("AI:", "").trim();
                    const playBtn = document.createElement("button");
                    playBtn.innerText = "üîä";
                    playBtn.style.marginLeft = "10px";
                    playBtn.style.fontSize = "12px";
                    playBtn.onclick = () => {
                        const utterance = new SpeechSynthesisUtterance(textToRead);
                        window.speechSynthesis.speak(utterance);
                    };
                    currentAiResponse.appendChild(playBtn);
                }
                currentAiResponse = null;
                currentAiText = "";
                appendMessage("System", "--- End of Turn ---", "system");
            } else if (data.type === "error") {
                appendMessage("Error", data.content, "system");
            } else {
                // Handle any unrecognized message types
                console.log("Unhandled message type:", data.type, data);
                if (data.content) {
                    appendMessage("Debug", `[${data.type}] ${data.content}`, "system");
                }
            }
        };

        ws.onclose = () => {
            appendMessage("System", "Disconnected from server.", "system");
            statusIndicator.classList.remove("status-connected");
        };

        function startNewChat() {
            currentThreadId = "web_test_thread_" + Date.now();
            chatBox.innerHTML = "";
            appendMessage("System", "Started new chat (Thread ID: " + currentThreadId + ")", "system");
        }

        async function toggleRecording() {
            const btn = document.getElementById("record-btn");
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const reader = new FileReader();
                        const modelSelect = document.getElementById("model-select");
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            const base64Audio = reader.result;
                            ws.send(JSON.stringify({
                                user_id: "web_test_user",
                                thread_id: currentThreadId,
                                audio_data: base64Audio,
                                model_preference: modelSelect.value
                            }));
                        };
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    btn.innerText = "‚èπ Stop";
                    btn.style.backgroundColor = "red";
                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    alert("Could not access microphone.");
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.innerText = "üé§ Record";
                btn.style.backgroundColor = "";
            }
        }

        async function sendMessage() {
            const input = document.getElementById("message-input");
            const imageInput = document.getElementById("image-input");
            const modelSelect = document.getElementById("model-select");
            const message = input.value;
            const file = imageInput.files[0];

            if (!message && !file) return;

            appendMessage("You", message + (file ? " [Image Attached]" : ""), "user");

            const payload = {
                user_id: "web_test_user",
                thread_id: currentThreadId,
                message: message,
                model_preference: modelSelect.value
            };

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    payload.image_data = e.target.result; // Base64 data URI
                    ws.send(JSON.stringify(payload));
                };
                reader.readAsDataURL(file);
            } else {
                ws.send(JSON.stringify(payload));
            }

            input.value = "";
            imageInput.value = "";
        }

        function appendMessage(sender, text, className) {
            const div = document.createElement("div");
            div.className = `message ${className}`;
            div.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }
    </script>
</body>

</html>